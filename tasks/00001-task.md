# Исправление TAPOS для TRON без blockHeader

## Контекст
- При broadcast TRC‑20 получаем TAPOS_ERROR, когда подписываем через wallet‑core, передавая только blockId/blockNumber.
- Требование: API должно оставаться простым; не просить у клиента полный blockHeader; использовать ref_block_bytes/ref_block_hash.
- Текущее решение с blockHeader нужно откатить.

## Цель
Сделать путь build/sign, который принимает ref_block_bytes/ref_block_hash (или получает эквивалент внутри сервиса), чтобы broadcast проходил без передачи blockHeader в публичном API.

## Ограничения
- Не добавлять зависимости/изменения пайплайна без отдельного согласования.
- По возможности оставаться на wallet‑core как источнике подписи.
- Соблюдать существующие правила ошибок/DTO.

## Варианты решения
### Вариант A — rawJson подпись через wallet‑core
Использовать `SigningInput.rawJson` + `SigningInput.txId` для подписи raw JSON транзакции, где заданы ref_block_bytes/ref_block_hash.
- Плюсы: простой публичный API; ref_block_* задаёт клиент.
- Минусы: нужен точный формат rawJson и вычисление txId (SHA256(raw_data)); возможно потребуется вспомогательная библиотека → нужна предварительная проверка/согласование.

### Вариант B — получение block header на сервере
Оставить proto‑first, но внутри сервиса запрашивать актуальный блок (getnowblock) и заполнять полный BlockHeader, чтобы wallet‑core корректно вывел ref_block_hash.
- Плюсы: публичный API не меняется; не нужен rawJson.
- Минусы: появляется сетевой вызов и конфиг ноды; больше точек отказа.

### Вариант C — собственная подпись без wallet‑core
Собрать raw_data с ref_block_* и подписать secp256k1‑библиотекой.
- Плюсы: полный контроль.
- Минусы: новый крипто‑стек, выше риск и объём работ; требует отдельного согласования.

## Рекомендуемый следующий шаг (до реализации)
Провести локальный эксперимент: принимает ли wallet‑core TRON подпись через rawJson + txId и какой точный формат rawJson нужен. Если вариант A работает — идём по нему, иначе рассматриваем вариант B.

## План реализации (после аппрува)
1) **Проверка**
   - Написать небольшой локальный скрипт для rawJson + txId подписи TRON через wallet‑core.
   - Зафиксировать результат в docs/agents/.
2) **API/DTO**
   - Добавить refBlockBytes/refBlockHash (и при необходимости txId) в нужные DTO (build/sign).
   - Убрать blockHeader из публичных DTO.
3) **Подписание**
   - Вариант A: формирование rawJson, вычисление txId, подпись через wallet‑core.
   - Вариант B: запрос getnowblock, заполнение BlockHeader, подпись как сейчас.
4) **Тесты**
   - DTO‑валидации refBlock полей.
   - Адаптер/сервис тесты для нового пути.
5) **Документация**
   - Обновить troubleshooting/decisions под выбранный подход.

## Открытые вопросы
- Допускаем ли конфигурацию Tron RPC (для варианта B)?
- Можно ли добавлять зависимости, если rawJson потребует вспомогательного кода?

## Аппрув
Одобрено: Нет
Причина: Не актуально
