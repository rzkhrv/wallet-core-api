# Требования: Wallet Core API (REST)

## 1. Контекст и текущая структура проекта
Текущее состояние репозитория (фактическая структура):
- `src` содержит только базовый каркас NestJS (`app.module.ts`, `app.controller.ts`, `main.ts`).
- Каталогов `common`, `coins`, `adapter` пока нет.
- Пакеты `@trustwallet/wallet-core`, `class-validator`, `class-transformer`, `@nestjs/swagger` уже установлены.

## 2. Цели и область работ
Цель: реализовать REST API на NestJS для операций с мнемониками, адресами и транзакциями на базе `@trustwallet/wallet-core` через адаптеры.

В область работ входит:
- Реализация REST API v1 для мнемоники, адресов и транзакций.
- Изоляция работы с `wallet-core` в адаптерах.
- DTO для REST API и отдельные DTO для адаптеров.
- Валидация входных параметров с использованием `class-validator`.
- Документация Swagger для всех эндпоинтов.
- Юнит-тесты и e2e тесты (минимальный набор для основных потоков).

В область работ не входит:
- Реализация UI/клиентских приложений.
- Хранение данных (БД), если не будет явно необходимо.
- Полная поддержка всех монет `wallet-core` без явной необходимости.

## 3. Архитектурные требования
### 3.1. Модули и структура
Нужно реализовать структуру, близкую к следующей:
```
src
- common
  -- mnemonic
  --- dto
  ---- request
  ---- response
  --- enum
  --- mnemonic.controller.ts
  --- mnemonic.module.ts
  --- mnemonic.service.ts
- coins
  -- <coin>
  --- dto
  ---- request
  ---- response
  --- enum
  --- service
  ---- <coin>-address.service.ts
  ---- <coin>-transaction.service.ts
  --- <coin>-address.controller.ts
  --- <coin>-transaction.controller.ts
  --- <coin>.module.ts
- adapter
  -- common
  --- dto
  ---- mnemonic
  --- mnemonic.adapter.ts
  --- wallet-core.adapter.ts
  -- coins
  --- <coin>
  ---- <coin>-address.adapter.ts
  ---- <coin>-transaction.adapter.ts
```

### 3.2. Изоляция `wallet-core`
Весь доступ к `@trustwallet/wallet-core` осуществляется только из адаптеров.
Сервисы REST API работают исключительно с DTO адаптеров и DTO REST API.

### 3.3. DTO и валидация
- Для каждого эндпоинта должны быть отдельные DTO:
  - REST API DTO (request/response).
  - DTO адаптера (request/response).
- Валидация обязательна для всех входных параметров.
- Для значений с ограниченным набором значений использовать `enum`.

### 3.4. Ошибки и ответы
- Все ответы и ошибки должны иметь единообразный формат (например: `{ "error": { "code": "...", "message": "...", "details": ... } }`).
- Некорректный ввод должен приводить к `400 Bad Request`.
- Ошибки адаптера должны быть преобразованы в понятные REST-ошибки.

## 4. REST API (v1)
### 4.1. Генерация мнемоники
`POST /api/v1/mnemonic/generate`

Запрос:
```
{
  "strength": 128,
  "passphrase": "123456"
}
```
Ответ:
```
{
  "mnemonic": "...",
  "isPassphraseUsed": true,
  "strengthBits": 128
}
```
Требования:
- `strength` обязательное поле, разрешены только валидные значения BIP39 (например: 128/160/192/224/256).
- `passphrase` опционально, по умолчанию пустая строка.

### 4.2. Валидация мнемоники
`POST /api/v1/mnemonic/validate`

Запрос:
```
{
  "mnemonic": "...",
  "passphrase": "123456"
}
```
Ответ:
```
{
  "isValid": true
}
```
Требования:
- `mnemonic` обязательное поле, строка.
- `passphrase` опционально, по умолчанию пустая строка.

### 4.3. Генерация адреса
`POST /api/v1/address/{coin}/generate`

Запрос:
```
{
  "mnemonic": {
    "value": "сама мнемоника",
    "passphrase": "если есть или пустая строка"
  },
  "derivation": {
    "account": 0,
    "change": 0,
    "index": 0
  }
}
```
Ответ:
```
{
  "address": "...",
  "keys": {
    "public": "...",
    "private": "..."
  },
  "derivation": {
    "path": "...",
    "purpose": 84,
    "coin": "...",
    "account": 0,
    "change": 0,
    "index": 0
  }
}
```
Требования:
- `{coin}` должен быть строго валидирован (enum поддерживаемых монет).
- Валидация структуры `mnemonic` и `derivation`.
- Поддержка coin-specific derivation правил.

### 4.4. Валидация адреса
`POST /api/v1/address/{coin}/validate`

Запрос:
```
{
  "address": "..."
}
```
Ответ:
```
{
  "isValid": true
}
```
Требования:
- `{coin}` валидировать через enum.
- Адрес валидируется через адаптер соответствующей монеты.

### 4.5. Создание и подпись транзакции
`POST /api/v1/transaction/{coin}/build-transaction`

Требования:
- DTO запроса и ответа специфичны для каждой монеты.
- Валидация всех параметров.
- Адаптер возвращает подписанную транзакцию (raw tx) и метаданные.

### 4.6. Создание и подпись трансфера токенов
`POST /api/v1/transaction/{coin}/build-transfer`

Требования:
- Поддержка токенов (ERC20/BEP20/TRC20/BRC20 и др. при наличии в `wallet-core`).
- DTO запроса и ответа специфичны для каждой монеты и стандарта токена.
- Валидация адресов, сумм, параметров токена.

## 5. Нефункциональные требования
- Использовать только уже установленные пакеты.
- Если новые пакеты нужны, устанавливать только последние версии и проверить это дважды.
- Код должен быть покрыт тестами:
  - Юнит-тесты адаптеров и сервисов.
  - E2E тесты для основных эндпоинтов.
- Логирование ошибок и ключевых операций (уровни: info/warn/error).
- Swagger-документация по всем эндпоинтам.

## 6. План разработки (разбит на малые задачи)
1) Создать базовую структуру модулей (`common`, `coins`, `adapter`) и подключить их в `app.module.ts`.
2) Реализовать адаптер и DTO для мнемоники (generate/validate).
3) Реализовать REST API для мнемоники и валидацию DTO.
4) Спроектировать поддержку монет (enum, конфигурация, базовые интерфейсы).
5) Реализовать адаптеры и DTO для генерации адреса одной монеты (например, BTC) как референс.
6) Реализовать REST API для адреса (generate/validate) для выбранной монеты.
7) Реализовать адаптеры и DTO для транзакций (build-transaction) для одной монеты.
8) Реализовать адаптеры и DTO для transfer-транзакций для одной монеты/токена.
9) Добавить обработку ошибок и единый формат ответов.
10) Добавить Swagger-документацию.
11) Написать юнит-тесты и e2e тесты для мнемоники и одной монеты.
12) Расширить поддержку дополнительных монет по шаблону.
