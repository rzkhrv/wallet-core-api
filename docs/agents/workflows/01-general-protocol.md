# ТЗ: выполнение задач только через файл таски и явное принятие плана

## 0) Назначение

Это ТЗ задаёт строгий протокол для агента: сначала — детальный план в файле таски, затем — выполнение только после явного подтверждения человеком через тег в начале файла. ИМЕЕТ НАИВЫСШИЙ ПРИОРИТЕТ.
Цель: предсказуемость, контроль изменений, безопасность при работе с кодом и особенно с БД.

---

## 1) Термины

- Файл таски — Markdown-файл (например, `tasks/00001-task.md`), который является единственным источником правды о том, что нужно сделать.
- Владелец — человек, который читает/правит файл таски и принимает план.
- Агент — исполнитель, который:
  - заполняет план,
  - ждёт принятия,
  - выполняет только принятое.
- Реализация / выполнение — любые действия, которые вносят изменения в проект/среду или могут повлиять на данные, например:
  - редактирование файлов репозитория,
  - запуск команд, которые создают/изменяют артефакты (сборка, генерация кода, миграции),
  - подключение к БД, выполнение запросов, миграций, backfill,
  - изменение конфигов, секретов, инфраструктуры.
- План — часть файла таски, где подробно описано что, как и почему будет сделано, а также тесты, риски, откат.

---

## 2) Непереговорные правила (Hard Rules)

### R1. План обязателен до любой реализации
Перед любыми действиями, которые можно трактовать как реализацию, агент обязан сначала заполнить план в файле таски:
что делаем → почему → как делаем (детали реализации) → как тестируем → как откатываем.

### R2. “Гейт” на выполнение: тег принятия в начале файла
Чтобы начать реализацию, агент обязан проверить первую непустую строку файла таски:

- если первая непустая строка строго равна:
  - `[accepted]`
- только тогда разрешено выполнять план.

Если тега нет — выполнять план СТРОГО ЗАПРЕЩЕНО.

Важно (строго):
- проверяется первая непустая строка, а не “где-то в файле”;
- тег чувствителен к регистру и пробелам;
- наличие похожих строк/примеров/комментариев в середине файла не считается принятием.

### R3. Агенту запрещено добавлять тег принятия
Агент никогда не пишет в файл таски `[accepted]` (ни как строку, ни как “пример”, ни в комментариях).
Тег добавляет только владелец задачи.

### R4. Выполнять можно только то, что согласовано в файле
После принятия:
- выполняй только шаги, описанные в файле таски;
- никаких “бонусных” рефакторингов, переименований, форматирований “заодно”, добавления зависимостей, изменения API, если этого нет в плане/критериях;
- если выяснилось, что нужно сделать что-то ещё → остановись, допиши изменения в план и жди нового принятия (см. R2–R3).

### R5. Файл может быть изменён: всегда перечитывай перед выполнением
Файл таски может быть отредактирован человеком в любой момент. Поэтому агент обязан:
1) перечитать файл перед стартом выполнения;
2) перечитывать файл непосредственно перед критическими шагами (миграции БД, удаление/изменение данных, массовые изменения кода, деплой/релиз);
3) если содержимое изменилось так, что план/критерии больше не совпадают — остановиться и запросить повторное принятие.

Рекомендуемый механизм защиты от “тихих” изменений:
в плановой части файла хранить `Plan-Digest` (например, SHA-256 от секции “План”), и перед стартом выполнения сверять его. Если digest не совпал — считать план изменённым → не выполнять.

---

## 3) Разрешённые действия ДО принятия (когда тега нет)

Когда нет `[accepted]`, агент может:
- читать файлы репозитория;
- делать анализ/поиск по коду (grep/ripgrep, просмотр конфигов, чтение документации в репо);
- задавать вопросы (в файле таски и/или в чате);
- заполнять/уточнять план в файле таски.

Запрещено до принятия:
- править файлы проекта (кроме файла таски);
- выполнять миграции/скрипты, которые меняют состояние/данные;
- подключаться к БД;
- запускать команды, приводящие к изменению проекта/артефактов (если это может считаться реализацией).

Если необходимо уточнение, агент фиксирует это в секции “Открытые вопросы” и останавливается.

---

## 4) Поведение ПОСЛЕ принятия (когда тег есть)

Если первая непустая строка файла — `[accepted]`, агент:
1) перечитывает файл таски целиком;
2) фиксирует, что будет выполнено строго в рамках принятого плана;
3) выполняет шаги по порядку;
4) ведёт “Execution log” (команды, файлы, результаты тестов);
5) если нужен выход за рамки — останавливается, дописывает изменения в план, и ждёт нового принятия.

Ограничение на правки файла таски после принятия:
- допустимо обновлять только секции статуса/прогресса/логов;
- изменения в “Плане/Скоупе/Критериях” считаются сменой договорённости → требуются новая правка владельцем и повторное принятие (агент не ставит тег).

---

## 5) Требования к содержанию плана (минимум)

В файле таски (в секции плана) агент обязан описать:

1) Цель: что должно измениться для пользователя/системы.
2) Контекст: где в коде/архитектуре это находится.
3) Невключённый скоуп (Non-goals): что точно не делаем.
4) Подход: почему выбран этот вариант (альтернативы кратко).
5) Шаги реализации: последовательность шагов с ожидаемым результатом.
6) Файлы/компоненты: какие части будут затронуты.
7) Тестирование: что и как проверяем (юнит/интеграционные/e2e, ручные шаги).
8) Риски: технические/продуктовые/безопасность.
9) Откат: как вернуться назад, что делать при ошибках.
10) БД (если применимо): см. раздел 6.

Дополнительно:
- Если есть “Открытые вопросы”, обязательно добавить блок “Ответы на открытые вопросы”.

---

## 6) Дополнительные требования при работе с БД (если есть БД-часть)

Перед любыми действиями с БД план обязан включать:

- Какие таблицы/модели затрагиваем.
- Какие изменения схемы (миграции), индексы, ограничения.
- Стратегию миграции:
  - backward-compatible (по возможности),
  - порядок выката,
  - флаги/двухфазные изменения, если нужно.
- План backfill (если требуется):
  - объём,
  - батчинг,
  - нагрузка,
  - мониторинг.
- Риски блокировок/долгих транзакций.
- План бэкапа/снимка (если релевантно) и откат:
  - rollback миграции (если возможно),
  - компенсирующие миграции,
  - восстановление данных.

До принятия плана любые подключения/запросы к БД запрещены.

---

## 7) “Стоп-условия” (когда нужно остановиться)

Агент обязан остановиться и не выполнять реализацию, если:
- нет `[accepted]` в первой непустой строке;
- файл изменился и план/критерии стали неоднозначными;
- выполнение шага требует действий, которых нет в плане;
- в плане отсутствует критичная информация (особенно про БД);
- появились новые требования/риски → нужно согласование.

---

## 8) Рекомендуемая проверка (псевдологика)

1) Открыть файл таски.
2) Найти первую непустую строку.
3) Если она != `[accepted]`:
   - заполнить/уточнить план,
   - зафиксировать вопросы,
   - завершить работу без реализации.
4) Если она == `[accepted]`:
   - перечитать файл,
   - сверить `Plan-Digest` (если используется),
   - выполнить план строго по шагам,
   - вести лог выполнения.

---

## 9) Форматирование и дисциплина изменений

- План должен быть достаточно детальным, чтобы владелец мог принять/не принять решение без додумывания.
- В шагах реализации:
  - использовать чекбоксы,
  - указывать ожидаемый результат,
  - указывать файлы/директории, если это помогает.
- Любые допущения писать явно.

